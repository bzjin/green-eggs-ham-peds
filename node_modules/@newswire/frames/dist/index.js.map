{"version":3,"file":"index.js","sources":["../src/utils.mjs","../src/constants.mjs","../src/framer.mjs","../src/frames.mjs"],"sourcesContent":["/**\n * A white-list of attributes to consider booleans for our purposes. Because\n * iframe attributes like \"sandbox\" actually mean something when they're an\n * empty string, we can't assume that means \"true\" across the board.\n *\n * @private\n * @type {Array}\n */\nconst booleans = ['allowfullscreen'];\n\n/**\n * Searches an element's attributes and returns an Object of all the ones that\n * begin with a specified prefix. Each matching attribute name is returned\n * without the prefix.\n *\n * @private\n * @param  {Element} element\n * @param  {string} prefix\n * @return {object}\n */\nfunction getMatchingAttributes(element, prefix) {\n  // prepare the object to return\n  const attrs = {};\n\n  // grab all the attributes off the element\n  const map = element.attributes;\n\n  // get a count of the number of attributes\n  const length = map.length;\n\n  // get the prefix's length\n  const prefixLength = prefix.length;\n\n  // loop through the attributes\n  for (let i = 0; i < length; i++) {\n    // get each attribute key\n    const key = map[i].name;\n\n    // continue if the key begins with supplied prefix\n    if (key.substr(0, prefixLength) === prefix) {\n      // slice off the prefix to get the bare field key\n      const field = key.slice(prefixLength);\n\n      // grab the value associated with the key\n      let value = map[i].value;\n\n      if (booleans.indexOf(field) > -1) {\n        value = true;\n      }\n\n      // add matching key to object\n      attrs[field] = value;\n    }\n  }\n\n  return attrs;\n}\n\nfunction extend(obj, props) {\n  for (let i in props) obj[i] = props[i];\n  return obj;\n}\n\nexport { extend, getMatchingAttributes };\n","const EMBED_SIZE = 'embed-size';\nconst AMP_SENTINEL = 'amp';\nconst FRAME_PREFIX = 'data-frame-';\nconst FRAME_AUTO_INITIALIZED_ATTRIBUTE = `${FRAME_PREFIX}auto-initialized`;\nconst FRAME_SRC_ATTRIBUTE = `${FRAME_PREFIX}src`;\n\nexport {\n  AMP_SENTINEL,\n  EMBED_SIZE,\n  FRAME_PREFIX,\n  FRAME_AUTO_INITIALIZED_ATTRIBUTE,\n  FRAME_SRC_ATTRIBUTE,\n};\n","import { extend, getMatchingAttributes } from './utils.mjs';\nimport {\n  AMP_SENTINEL,\n  EMBED_SIZE,\n  FRAME_PREFIX,\n  FRAME_AUTO_INITIALIZED_ATTRIBUTE,\n  FRAME_SRC_ATTRIBUTE,\n} from './constants.mjs';\n\n/**\n * The Framer object to be called in the host page. Effectively a wrapper around\n * interactions with an embedded iframe.\n *\n * @param {object} options options used to prepare the iframe\n * @param {Element} options.container the containing DOM element for the iframe\n * @param {string} options.src the URL to set as the `src` of the iframe\n * @param {boolean} [options.allowfullscreen] toggles the `allowfullscreen` attribute\n * @param {string} [options.name] sets the `name` attribute\n * @param {string} [options.referrerpolicy] sets the `referrerpolicy` attribute\n * @param {string} [options.sandbox] sets the `sandbox` attribute\n * @param {string} [options.title] sets the `title` attribute\n */\nclass Framer {\n  constructor({\n    allowfullscreen = false,\n    container,\n    name,\n    referrerpolicy,\n    sandbox = 'allow-scripts',\n    src,\n    title,\n  }) {\n    this.container = container;\n    this.src = src;\n    this.allowfullscreen = allowfullscreen;\n    this.name = name;\n    this.referrerpolicy = referrerpolicy;\n    this.sandbox = sandbox;\n    this.title = title;\n\n    this.processMessage_ = this.processMessage_.bind(this);\n    window.addEventListener('message', this.processMessage_, false);\n\n    this.createIframe_();\n  }\n\n  /**\n   * Removes event listeners and removes the iframe from the container.\n   *\n   * @returns {void}\n   * @example\n   *\n   * const framer = new Framer(...);\n   * // tears down the Framer\n   * framer.remove();\n   */\n  remove() {\n    window.removeEventListener('message', this.processMessage_, false);\n    this.container.removeChild(this.iframe);\n    // important to de-reference the iframe so it can be GC'ed\n    this.iframe = null;\n  }\n\n  /**\n   * Creates the iframe element and sets the source of the iframe.\n   *\n   * @private\n   * @returns {void}\n   */\n  createIframe_() {\n    const iframe = (this.iframe = document.createElement('iframe'));\n\n    iframe.setAttribute('src', this.src);\n    iframe.setAttribute('width', '100%');\n    iframe.setAttribute('scrolling', 'no');\n    iframe.setAttribute('marginheight', '0');\n    iframe.setAttribute('frameborder', '0');\n\n    if (this.allowfullscreen) {\n      iframe.setAttribute('allowfullscreen', '');\n    }\n\n    if (this.name) {\n      iframe.setAttribute('name', name);\n    }\n\n    if (this.referrerpolicy) {\n      iframe.setAttribute('referrerpolicy', this.referrerpolicy);\n    }\n\n    iframe.setAttribute('sandbox', this.sandbox);\n\n    if (this.title) {\n      iframe.setAttribute('title', this.title);\n    }\n\n    this.container.appendChild(iframe);\n  }\n\n  /**\n   * Receives a message from the frame. Checks to make sure it is only listening\n   * to the iframe it created, and that the sentinel value and type matches.\n   *\n   * @private\n   * @param {Event} event\n   * @returns {void}\n   */\n  processMessage_(event) {\n    // this message isn't from our created frame, stop here\n    if (event.source !== this.iframe.contentWindow) return;\n\n    const { data } = event;\n\n    // if the sentinel and type matches, update our height\n    if (data.sentinel === AMP_SENTINEL && data.type === EMBED_SIZE) {\n      this.setIframeHeight_(data.height);\n    }\n  }\n\n  /**\n   * Sets the iframe's height.\n   *\n   * @private\n   * @param {number} height\n   * @returns {void}\n   */\n  setIframeHeight_(height) {\n    this.iframe.setAttribute('height', height);\n  }\n}\n\n/**\n * Automatically initializes any frames that have not already been\n * auto-activated.\n *\n * @returns {Array} An array of all the created Framers\n * @example\n *\n * // sets up all frames that have not been initialized yet\n * autoInitFrames();\n */\nfunction autoInitFrames() {\n  const elements = document.querySelectorAll(\n    `[${FRAME_SRC_ATTRIBUTE}]:not([${FRAME_AUTO_INITIALIZED_ATTRIBUTE}])`\n  );\n\n  const activated = [];\n\n  for (let i = 0; i < elements.length; i++) {\n    const container = elements[i];\n\n    const attributes = getMatchingAttributes(container, FRAME_PREFIX);\n    container.setAttribute(FRAME_AUTO_INITIALIZED_ATTRIBUTE, '');\n\n    activated.push(\n      new Framer(\n        extend(\n          {\n            container,\n          },\n          attributes\n        )\n      )\n    );\n  }\n\n  return activated;\n}\n\nexport { autoInitFrames, Framer };\n","// internal\nimport { AMP_SENTINEL, EMBED_SIZE } from './constants.mjs';\nimport { extend } from './utils.mjs';\n\n/**\n * A wrapper around postMessage to normalize the message body. Automatically\n * includes the AMP sentinel value.\n *\n * @private\n * @param {string} type Type of message being sent\n * @param {Object} [data] Any additional data to send\n * @returns {void}\n */\nfunction sendMessage(type, data = {}) {\n  window.parent.postMessage(\n    extend({ sentinel: AMP_SENTINEL, type }, data),\n    '*'\n  );\n}\n\n/**\n * Gets the height of the current document's body. Uses offsetHeight to ensure\n * that margins are accounted for.\n *\n * @private\n * @returns {number}\n */\nfunction getDocumentHeight() {\n  return document.documentElement.offsetHeight;\n}\n\n/**\n * Sends the current document's height or provided value to the host window\n * using postMessage.\n *\n * @param {number} [height] The height to pass to the host page, is determined automatically if not passed\n * @returns {void}\n * @example\n *\n * // Uses the document's height to tell the host page\n * sendFrameHeight();\n *\n * // Pass a height you've determined in another way\n * sendFrameHeight(500);\n *\n */\nfunction sendFrameHeight(height = getDocumentHeight()) {\n  sendMessage(EMBED_SIZE, { height });\n}\n\n/**\n * Sets up an event listener for the load event that sends the new frame\n * height to the host. Automatically removes itself once fired.\n *\n * @returns {void}\n * @example\n *\n * // once the frame's load event is fired, tell the host page its new height\n * sendHeightOnLoad();\n */\nfunction sendHeightOnLoad() {\n  window.addEventListener('load', function cb() {\n    sendFrameHeight();\n\n    window.removeEventListener('load', cb);\n  });\n}\n\n/**\n * Sets up an event listener for the resize event that sends the new frame\n * height to the host.\n *\n * @returns {void}\n * @example\n *\n * // every time the frame is resized, tell the host page what its new height is\n * sendHeightOnResize();\n */\nfunction sendHeightOnResize() {\n  window.addEventListener('resize', () => sendFrameHeight());\n}\n\n/**\n * Sends height updates to the host page on an interval.\n *\n * @param {number} [delay] How long to set the interval\n * @returns {void}\n * @example\n *\n * // will call sendFrameHeight every 300ms\n * sendHeightOnPoll();\n *\n * // will call sendFrameHeight every 150ms\n * sendHeightOnPoll(150);\n */\nfunction sendHeightOnPoll(delay = 300) {\n  setInterval(sendFrameHeight, delay);\n}\n\n/**\n * A helper for running the standard functions for setting up a frame.\n *\n * Automatically calls an sendFrameHeight, sendHeightOnLoad and sendHeightOnResize.\n *\n * @returns {void}\n * @example\n *\n * initFrame();\n */\nfunction initFrame() {\n  sendFrameHeight();\n  sendHeightOnLoad();\n  sendHeightOnResize();\n}\n\n/**\n * Initializes a frame, then sets up a poll to continue to update on an interval.\n *\n * @param {number} [delay] An optional custom delay to pass to sendHeightOnPoll\n * @returns {void}\n * @example\n *\n * // calls initFrame, then calls sendHeightOnPoll\n * initFrameAndPoll();\n */\nfunction initFrameAndPoll(delay) {\n  initFrame();\n  sendHeightOnPoll(delay);\n}\n\nexport {\n  initFrame,\n  initFrameAndPoll,\n  sendFrameHeight,\n  sendHeightOnLoad,\n  sendHeightOnPoll,\n  sendHeightOnResize,\n};\n"],"names":["const","booleans","getMatchingAttributes","element","prefix","attrs","map","attributes","length","prefixLength","i","key","name","substr","field","slice","value","indexOf","extend","obj","props","let","EMBED_SIZE","AMP_SENTINEL","Framer","constructor","ref","container","src","allowfullscreen","referrerpolicy","sandbox","title","processMessage_","this","bind","window","addEventListener","createIframe_","sendFrameHeight","height","data","document","documentElement","offsetHeight","parent","postMessage","sentinel","sendHeightOnLoad","cb","removeEventListener","sendHeightOnResize","sendHeightOnPoll","delay","setInterval","initFrame","remove","removeChild","iframe","createElement","setAttribute","appendChild","event","source","contentWindow","type","setIframeHeight_","elements","querySelectorAll","activated","FRAME_PREFIX","push"],"mappings":"AAQAA,IAAMC,EAAW,CAAC,mBAYlB,SAASC,EAAsBC,EAASC,WAEhCC,EAAQ,GAGRC,EAAMH,EAAQI,WAGdC,EAASF,EAAIE,OAGbC,EAAeL,EAAOI,OAGnBE,EAAI,EAAGA,EAAIF,EAAQE,IAAK,KAEzBC,EAAML,EAAII,GAAGE,QAGfD,EAAIE,OAAO,EAAGJ,KAAkBL,EAAQ,KAEpCU,EAAQH,EAAII,MAAMN,GAGpBO,EAAQV,EAAII,GAAGM,MAEff,EAASgB,QAAQH,IAAU,IAC7BE,GAAQ,GAIVX,EAAMS,GAASE,UAIZX,EAGT,SAASa,EAAOC,EAAKC,OACdC,IAAIX,KAAKU,EAAOD,EAAIT,GAAKU,EAAMV,UAC7BS,EC5DTnB,IAAMsB,EAAa,aACbC,EAAe,MCqBfC,EACJC,SAAYC,2CACQ,8DAIR,4CAILC,2BACAC,IAAMA,OACNC,gBAAkBA,OAClBjB,KAAOA,OACPkB,eAAiBA,OACjBC,QAAUA,OACVC,MAAQA,OAERC,EAAkBC,KAAKD,EAAgBE,KAAKD,MACjDE,OAAOC,iBAAiB,UAAWH,KAAKD,GAAiB,QAEpDK,KCGT,SAASC,EAAgBC,GAjCzB,IAA2BC,iBAelBC,SAASC,gBAAgBC,wBAfPH,EAkCD,QAAED,QAlCM,IAChCJ,OAAOS,OAAOC,YACZ5B,EAAO,CAAE6B,SAAUxB,OAgCTD,GAhC+BmB,GACzC,KA4CJ,SAASO,IACPZ,OAAOC,iBAAiB,OAAQ,SAASY,IACvCV,IAEAH,OAAOc,oBAAoB,OAAQD,KAcvC,SAASE,IACPf,OAAOC,iBAAiB,2BAAgBE,MAgB1C,SAASa,EAAiBC,kBAAQ,KAChCC,YAAYf,EAAiBc,GAa/B,SAASE,IACPhB,IACAS,IACAG,IDxDAK,YAAAA,kBACEpB,OAAOc,oBAAoB,UAAWhB,KAAKD,GAAiB,QACvDN,UAAU8B,YAAYvB,KAAKwB,aAE3BA,OAAS,MAShBpB,YAAAA,iBACQoB,EAAUxB,KAAKwB,OAAShB,SAASiB,cAAc,YAE9CC,aAAa,MAAO1B,KAAKN,OACzBgC,aAAa,QAAS,UACtBA,aAAa,YAAa,QAC1BA,aAAa,eAAgB,OAC7BA,aAAa,cAAe,KAE/B1B,KAAKL,mBACA+B,aAAa,kBAAmB,IAGrC1B,KAAKtB,QACAgD,aAAa,OAAQhD,MAG1BsB,KAAKJ,kBACA8B,aAAa,iBAAkB1B,KAAKJ,kBAGtC8B,aAAa,UAAW1B,KAAKH,SAEhCG,KAAKF,SACA4B,aAAa,QAAS1B,KAAKF,YAG/BL,UAAUkC,YAAYH,IAW7BzB,YAAAA,WAAgB6B,MAEVA,EAAMC,SAAW7B,KAAKwB,OAAOM,eAEzBvB,aAGJA,EAAKM,WAAaxB,GAAgBkB,EAAKwB,OAAS3C,QAC7C4C,EAAiBzB,EAAKD,UAW/B0B,YAAAA,WAAiB1B,QACVkB,OAAOE,aAAa,SAAUpB,2BAcvC,mBACQ2B,EAAWzB,SAAS0B,wEAIpBC,EAAY,GAET3D,EAAI,EAAGA,EAAIyD,EAAS3D,OAAQE,IAAK,KAClCiB,EAAYwC,EAASzD,GAErBH,EAAaL,EAAsByB,EDrJxB,eCsJjBA,EAAUiC,aDrJ4BU,8BCqJmB,IAEzDD,EAAUE,KACR,IAAI/C,EACFN,EACE,WACES,GAEFpB,YAMD8D,iECzCT,SAA0BhB,GACxBE,IACAH,EAAiBC"}